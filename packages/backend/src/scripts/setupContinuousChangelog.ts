import { AutoChangelogService } from '../services/autoChangelogService';
import { jobScheduler } from '../services/scheduledJobs';

async function setupContinuousChangelog() {
  console.log('ðŸš€ Setting up Continuous Git Changelog System\n');

  try {
    // 1. Initialize the auto-changelog service
    console.log('1ï¸âƒ£ Initializing Auto-Changelog Service...');
    const autoService = new AutoChangelogService();

    // 2. Test Git access
    console.log('\n2ï¸âƒ£ Testing Git Repository Access...');
    try {
      const result = await autoService.processNewCommits();
      console.log(`   âœ… Git access working - processed ${result.commitsProcessed} commits`);
      console.log(`   ðŸ“ Created ${result.entriesCreated} changelog entries`);
      if (result.changelogVersion) {
        console.log(`   ðŸ“‹ Using changelog: ${result.changelogVersion}`);
      }
    } catch (error) {
      console.error('   âŒ Git access failed:', error);
      throw error;
    }

    // 3. Check processing statistics
    console.log('\n3ï¸âƒ£ Checking Processing Statistics...');
    const stats = await autoService.getProcessingStats();
    console.log(`   ðŸ“Š Total commits tracked: ${stats.totalCommitsTracked}`);
    console.log(`   ðŸŒ Public commits tracked: ${stats.publicCommitsTracked}`);
    console.log(`   ðŸ¤– Auto-generated entries: ${stats.autoGeneratedEntries}`);
    console.log(`   ðŸ“ Unreleased entries: ${stats.unreleasedEntries}`);
    if (stats.lastProcessedCommit) {
      console.log(`   â° Last processed: ${stats.lastProcessedCommit.shortHash} - ${stats.lastProcessedCommit.subject}`);
    }

    // 4. Test scheduled job trigger
    console.log('\n4ï¸âƒ£ Testing Scheduled Job Integration...');
    try {
      const jobResult = await jobScheduler.triggerAutoChangelogProcessing();
      console.log(`   âœ… Scheduled job working - processed ${jobResult.commitsProcessed} commits`);
    } catch (error) {
      console.error('   âŒ Scheduled job failed:', error);
    }

    // 5. Display webhook configuration
    console.log('\n5ï¸âƒ£ Webhook Configuration...');
    console.log('   ðŸ”— Available webhook endpoints:');
    console.log('     â€¢ GitHub: POST /api/git-webhooks/github');
    console.log('     â€¢ GitLab: POST /api/git-webhooks/gitlab');
    console.log('     â€¢ Generic: POST /api/git-webhooks/generic');
    console.log('     â€¢ Test: POST /api/git-webhooks/test');
    console.log('     â€¢ Health: GET /api/git-webhooks/health');
    console.log('     â€¢ Config: GET /api/git-webhooks/config');

    // 6. Environment variables check
    console.log('\n6ï¸âƒ£ Environment Variables...');
    console.log(`   ðŸ” GitHub webhook secret: ${process.env.GITHUB_WEBHOOK_SECRET ? 'âœ… Set' : 'âŒ Not set'}`);
    console.log(`   ðŸ” GitLab webhook token: ${process.env.GITLAB_WEBHOOK_TOKEN ? 'âœ… Set' : 'âŒ Not set'}`);
    console.log(`   ðŸ” Generic webhook secret: ${process.env.GENERIC_WEBHOOK_SECRET ? 'âœ… Set' : 'âŒ Not set'}`);

    // 7. API endpoints summary
    console.log('\n7ï¸âƒ£ Available API Endpoints...');
    console.log('   ðŸ”§ Auto-processing endpoints:');
    console.log('     â€¢ POST /api/git-changelogs/admin/auto-process - Trigger manual processing');
    console.log('     â€¢ GET /api/git-changelogs/admin/auto-stats - Get processing statistics');
    console.log('     â€¢ POST /api/git-changelogs/admin/create-version - Create versioned changelog');
    console.log('   ðŸŒ Public endpoints:');
    console.log('     â€¢ GET /api/git-changelogs/markdown - Get changelog as markdown');
    console.log('     â€¢ GET /api/git-changelogs/export/json - Get changelog as JSON');

    console.log('\nâœ… Continuous Git Changelog System Setup Complete!');
    console.log('\nðŸ“‹ System Overview:');
    console.log('   â€¢ â° Scheduled Processing: Every 5 minutes');
    console.log('   â€¢ ðŸ”” Webhook Support: GitHub, GitLab, Generic');
    console.log('   â€¢ ðŸ“ Auto-Generated Entries: Appear in "Unreleased" changelog');
    console.log('   â€¢ ðŸš€ Version Creation: Manual or automated release creation');
    console.log('   â€¢ ðŸ”„ Real-time Updates: Commits become changelog entries automatically');

    console.log('\nðŸŽ¯ Next Steps:');
    console.log('   1. Set up webhook in your Git repository (optional)');
    console.log('   2. Configure environment variables for webhook security');
    console.log('   3. Monitor the "Unreleased" changelog for new entries');
    console.log('   4. Create versioned releases when ready');
    console.log('   5. Enjoy automated changelog generation! ðŸŽ‰');

  } catch (error) {
    console.error('âŒ Setup failed:', error);
    throw error;
  }
}

// Test continuous processing workflow
async function testContinuousWorkflow() {
  console.log('\nðŸ§ª Testing Continuous Workflow...\n');

  try {
    const autoService = new AutoChangelogService();

    // 1. Process new commits
    console.log('1ï¸âƒ£ Processing new commits...');
    const result1 = await autoService.processNewCommits();
    console.log(`   ðŸ“ Processed ${result1.commitsProcessed} commits, created ${result1.entriesCreated} entries`);

    // 2. Get current stats
    console.log('\n2ï¸âƒ£ Getting current statistics...');
    const stats = await autoService.getProcessingStats();
    console.log(`   ðŸ“Š Unreleased entries: ${stats.unreleasedEntries}`);

    // 3. Test version creation (if there are unreleased entries)
    if (stats.unreleasedEntries > 0) {
      console.log('\n3ï¸âƒ£ Testing version creation...');
      const testVersion = `v1.0.${Date.now()}`;
      try {
        const changelogId = await autoService.createVersionedChangelog(
          testVersion,
          `Test Release ${testVersion}`
        );
        console.log(`   âœ… Created test version ${testVersion} (changelog ID: ${changelogId})`);
        
        // Check stats after version creation
        const newStats = await autoService.getProcessingStats();
        console.log(`   ðŸ“Š Unreleased entries after version creation: ${newStats.unreleasedEntries}`);
      } catch (error) {
        console.error('   âŒ Version creation failed:', error);
      }
    } else {
      console.log('\n3ï¸âƒ£ No unreleased entries to create version from');
    }

    console.log('\nâœ… Continuous workflow test completed!');

  } catch (error) {
    console.error('âŒ Workflow test failed:', error);
    throw error;
  }
}

// Demonstrate webhook testing
async function testWebhookIntegration() {
  console.log('\nðŸ”— Testing Webhook Integration...\n');

  try {
    // Test the webhook endpoints
    console.log('1ï¸âƒ£ Webhook endpoints available:');
    console.log('   â€¢ Test webhook: curl -X POST "http://localhost:3000/api/git-webhooks/test"');
    console.log('   â€¢ Health check: curl -X GET "http://localhost:3000/api/git-webhooks/health"');
    console.log('   â€¢ Configuration: curl -X GET "http://localhost:3000/api/git-webhooks/config"');

    console.log('\n2ï¸âƒ£ GitHub webhook setup:');
    console.log('   â€¢ URL: http://your-domain.com/api/git-webhooks/github');
    console.log('   â€¢ Content type: application/json');
    console.log('   â€¢ Secret: Set GITHUB_WEBHOOK_SECRET environment variable');
    console.log('   â€¢ Events: Just the push event');

    console.log('\n3ï¸âƒ£ GitLab webhook setup:');
    console.log('   â€¢ URL: http://your-domain.com/api/git-webhooks/gitlab');
    console.log('   â€¢ Secret token: Set GITLAB_WEBHOOK_TOKEN environment variable');
    console.log('   â€¢ Trigger: Push events');

    console.log('\nâœ… Webhook integration ready!');

  } catch (error) {
    console.error('âŒ Webhook test failed:', error);
    throw error;
  }
}

// Run setup if this file is executed directly
if (require.main === module) {
  const command = process.argv[2];

  switch (command) {
    case 'test-workflow':
      testContinuousWorkflow()
        .then(() => {
          console.log('\nðŸŽ‰ Workflow test completed successfully!');
          process.exit(0);
        })
        .catch((error) => {
          console.error('\nðŸ’¥ Workflow test failed:', error);
          process.exit(1);
        });
      break;

    case 'test-webhooks':
      testWebhookIntegration()
        .then(() => {
          console.log('\nðŸŽ‰ Webhook test completed successfully!');
          process.exit(0);
        })
        .catch((error) => {
          console.error('\nðŸ’¥ Webhook test failed:', error);
          process.exit(1);
        });
      break;

    default:
      setupContinuousChangelog()
        .then(() => {
          console.log('\nðŸŽ‰ Setup completed successfully!');
          process.exit(0);
        })
        .catch((error) => {
          console.error('\nðŸ’¥ Setup failed:', error);
          process.exit(1);
        });
  }
}

export { setupContinuousChangelog, testContinuousWorkflow, testWebhookIntegration };
